<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Harvest Report</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- FontAwesome (for icons) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />

    <!-- Montserrat Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        /* Enhanced Oyster mushroom palette */
        --primary: #d6c1b1; /* Light mushroom tan */
        --primary-dark: #c0ab9b; /* Darker shade for hover states */
        --secondary: #8b786d; /* Medium mushroom brown */
        --accent: #4d6a6d; /* Complementary blue-green */
        --accent-light: #5d8286; /* Lighter accent for gradients */
        --light: #f5f1ed; /* Very light tan */
        --dark: #3a3238; /* Deep purple-brown */
        --highlight: #bed3c9; /* Soft sage green */

        /* New variables for modern design */
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
        --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
        --radius: 16px;
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(
          135deg,
          var(--light) 0%,
          var(--highlight) 100%
        );
        font-family: "Montserrat", sans-serif;
        color: var(--dark);
        min-height: 100vh;
      }

      /* Modern navbar styling */
      .navbar {
        background: linear-gradient(
          135deg,
          var(--accent) 0%,
          var(--dark) 100%
        ) !important;
        box-shadow: var(--shadow-md);
        padding: 0.5rem 1rem;
      }

      .navbar-brand {
        color: var(--light) !important;
        font-weight: 700;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        font-size: 1.4rem;
      }

      .navbar-brand i {
        color: var(--primary);
        font-size: 1.8rem;
        margin-right: 10px;
        transition: var(--transition);
      }

      .navbar-brand:hover i {
        transform: rotate(-15deg);
      }

      .nav-link {
        color: rgba(255, 255, 255, 0.85) !important;
        font-weight: 500;
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
        transition: var(--transition);
        position: relative;
        border-radius: var(--radius);
        margin: 0 0.2rem;
      }

      .nav-link:hover {
        color: var(--primary) !important;
        background: rgba(255, 255, 255, 0.1);
      }

      .nav-link.active {
        color: var(--primary) !important;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.15);
      }

      .nav-link i {
        margin-right: 8px;
        font-size: 1rem;
        width: 20px;
        text-align: center;
      }

      .dropdown-menu {
        border-radius: var(--radius);
        border: none;
        box-shadow: var(--shadow-md);
        background: white;
        overflow: hidden;
      }

      .dropdown-item {
        padding: 0.7rem 1.2rem;
        transition: var(--transition);
        color: var(--dark);
        font-weight: 500;
      }

      .dropdown-item:hover {
        background: var(--highlight);
        color: var(--dark);
      }

      .dropdown-item i {
        margin-right: 8px;
        color: var(--accent);
        width: 18px;
      }

      /* Main content */
      .report-container {
        padding: 2rem 1rem;
        max-width: 1400px;
        margin: 0 auto;
      }

      .page-header {
        background: white;
        padding: 2rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        margin-bottom: 2rem;
        text-align: center;
      }

      .page-title {
        color: var(--dark);
        font-weight: 700;
        font-size: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
      }

      .page-title i {
        color: var(--accent);
        margin-right: 15px;
        font-size: 1.8rem;
        background: linear-gradient(135deg, var(--accent), var(--accent-light));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .page-subtitle {
        color: var(--secondary);
        font-size: 1.1rem;
      }

      /* Print Header (hidden by default, shown only when printing) */
      .print-header {
        display: none;
      }

      /* Action buttons */
      .action-buttons {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .btn {
        border: none;
        border-radius: var(--radius);
        padding: 0.8rem 1.5rem;
        font-weight: 600;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--accent) 0%,
          var(--accent-light) 100%
        );
        color: white;
        box-shadow: var(--shadow-sm);
      }

      .btn-primary:hover {
        background: linear-gradient(
          135deg,
          var(--accent-light) 0%,
          var(--accent) 100%
        );
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        color: white;
      }

      .btn-secondary {
        background: linear-gradient(135deg, var(--secondary) 0%, #9c8a7f 100%);
        color: white;
        box-shadow: var(--shadow-sm);
      }

      .btn-secondary:hover {
        background: linear-gradient(135deg, #9c8a7f 0%, var(--secondary) 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        color: white;
      }

      .btn-success {
        background: linear-gradient(135deg, var(--highlight) 0%, #a8c8b9 100%);
        color: var(--dark);
        box-shadow: var(--shadow-sm);
      }

      .btn-success:hover {
        background: linear-gradient(135deg, #a8c8b9 0%, var(--highlight) 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        color: var(--dark);
      }

      .btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
        color: var(--dark);
        box-shadow: var(--shadow-sm);
      }

      .btn-warning:hover {
        background: linear-gradient(135deg, #ffb300 0%, #ffc107 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        color: var(--dark);
      }

      .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        box-shadow: var(--shadow-sm);
      }

      .btn-danger:hover {
        background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        color: white;
      }

      /* Filter section */
      .filter-section {
        background: white;
        padding: 1.5rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        margin-bottom: 2rem;
      }

      .filter-title {
        color: var(--dark);
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
      }

      .filter-title i {
        color: var(--accent);
        margin-right: 10px;
      }

      .form-control,
      .form-select {
        border: 1px solid color-mix(in srgb, var(--primary) 30%, transparent);
        border-radius: var(--radius);
        padding: 0.8rem 1rem;
        transition: var(--transition);
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 0.25rem
          color-mix(in srgb, var(--accent) 25%, transparent);
      }

      .input-group-text {
        background: color-mix(in srgb, var(--accent) 10%, transparent);
        border: 1px solid color-mix(in srgb, var(--primary) 30%, transparent);
        color: var(--accent);
        border-radius: var(--radius);
      }

      /* Table styling */
      .table-container {
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
        margin-bottom: 2rem;
      }

      .table {
        margin-bottom: 0;
        border-radius: var(--radius);
        overflow: hidden;
      }

      .table thead th {
        background: linear-gradient(
          135deg,
          var(--accent) 0%,
          var(--accent-light) 100%
        );
        color: white;
        border: none;
        padding: 1rem 1.5rem;
        font-weight: 600;
      }

      .table tbody td {
        padding: 1rem 1.5rem;
        border-color: color-mix(in srgb, var(--primary) 20%, transparent);
        vertical-align: middle;
      }

      .table-striped tbody tr:nth-of-type(odd) {
        background-color: color-mix(in srgb, var(--light) 70%, transparent);
      }

      .table-striped tbody tr:hover {
        background-color: color-mix(in srgb, var(--highlight) 30%, transparent);
      }

      /* Action buttons in table */
      .action-buttons-cell {
        white-space: nowrap;
      }

      .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
      }

      /* Modal styling */
      .modal-content {
        border-radius: var(--radius);
        border: none;
        box-shadow: var(--shadow-lg);
      }

      .modal-header {
        background: linear-gradient(
          135deg,
          var(--accent) 0%,
          var(--accent-light) 100%
        );
        color: white;
        border-bottom: none;
        padding: 1.5rem;
        position: relative;
      }

      .modal-title {
        font-weight: 600;
        display: flex;
        align-items: center;
      }

      .modal-title i {
        margin-right: 10px;
      }

      .modal-body {
        padding: 1.5rem;
      }

      .modal-footer {
        border-top: 1px solid
          color-mix(in srgb, var(--primary) 20%, transparent);
        padding: 1.5rem;
      }

      .btn-close {
        filter: brightness(0) invert(1);
        position: absolute;
        right: 1.5rem;
        top: 1.5rem;
      }

      /* Stats summary */
      .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: white;
        border-radius: var(--radius);
        padding: 1.5rem;
        text-align: center;
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-md);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--accent);
        margin-bottom: 0.5rem;
      }

      .stat-label {
        color: var(--secondary);
        font-weight: 500;
      }

      /* Toast notifications */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
      }

      /* Mushroom Bags Table Styling */
      .mushroom-bags-container {
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
        margin-bottom: 2rem;
        padding: 1.5rem;
      }

      .mushroom-bags-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid
          color-mix(in srgb, var(--primary) 20%, transparent);
      }

      .mushroom-bags-title {
        color: var(--dark);
        font-weight: 600;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        margin: 0;
      }

      .mushroom-bags-title i {
        color: var(--accent);
        margin-right: 10px;
        font-size: 1.5rem;
      }

      /* Enhanced badge styling */
      .badge {
        padding: 0.5rem 0.8rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 50px;
        text-transform: capitalize;
      }

      .bg-success {
        background: linear-gradient(
          135deg,
          #28a745 0%,
          #20c997 100%
        ) !important;
      }

      .bg-info {
        background: linear-gradient(
          135deg,
          #17a2b8 0%,
          #0dcaf0 100%
        ) !important;
      }

      .bg-warning {
        background: linear-gradient(
          135deg,
          #ffc107 0%,
          #fd7e14 100%
        ) !important;
        color: var(--dark) !important;
      }

      .bg-secondary {
        background: linear-gradient(
          135deg,
          #6c757d 0%,
          #adb5bd 100%
        ) !important;
      }

      .bg-danger {
        background: linear-gradient(
          135deg,
          #dc3545 0%,
          #e35d6a 100%
        ) !important;
      }

      .bg-primary {
        background: linear-gradient(
          135deg,
          var(--accent) 0%,
          var(--accent-light) 100%
        ) !important;
      }

      /* Table improvements */
      .table-responsive {
        border-radius: var(--radius);
        overflow: hidden;
      }

      .table tbody td {
        vertical-align: middle;
      }

      /* Notes column styling */
      .notes-cell {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .notes-cell:hover {
        white-space: normal;
        overflow: visible;
        position: relative;
        z-index: 10;
        background: white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        padding: 8px;
      }

      /* Action buttons improvements */
      .action-buttons-cell {
        white-space: nowrap;
        display: flex;
        gap: 0.5rem;
      }

      .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
        border-radius: 8px;
      }

      /* NEW: Mobile responsive cards for mushroom bags table */
      .mushroom-bag-card {
        display: none;
        background: white;
        border-radius: var(--radius);
        padding: 1.25rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
        border-left: 4px solid var(--accent);
      }

      .bag-card-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid
          color-mix(in srgb, var(--primary) 15%, transparent);
      }

      .bag-card-row:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .bag-card-label {
        font-weight: 600;
        color: var(--secondary);
        flex: 0 0 40%;
      }

      .bag-card-value {
        flex: 1;
        text-align: right;
      }

      .bag-card-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        margin-top: 1rem;
      }

      /* Responsive adjustments for mushroom bags table */
      @media (max-width: 768px) {
        .mushroom-bags-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 1rem;
        }

        .mushroom-bags-title {
          font-size: 1.1rem;
        }

        .action-buttons-cell {
          flex-direction: column;
          gap: 0.3rem;
        }

        .notes-cell {
          max-width: 150px;
        }

        /* NEW: Show cards and hide table on mobile */
        .mushroom-bags-table-container {
          display: none;
        }

        .mushroom-bag-card {
          display: block;
        }
      }

      @media (max-width: 576px) {
        .mushroom-bags-container {
          padding: 1rem;
        }

        .table thead th,
        .table tbody td {
          padding: 0.6rem 0.8rem;
          font-size: 0.9rem;
        }

        .badge {
          padding: 0.3rem 0.6rem;
          font-size: 0.7rem;
        }

        .bag-card-actions {
          flex-direction: column;
        }
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .report-container {
          padding: 1.5rem 1rem;
        }

        .page-title {
          font-size: 1.5rem;
        }

        .action-buttons {
          flex-direction: column;
        }

        .stats-summary {
          grid-template-columns: 1fr;
        }

        .table thead th,
        .table tbody td {
          padding: 0.8rem 1rem;
        }

        .action-buttons-cell {
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
        }

        .toast-container {
          left: 20px;
          right: 20px;
        }
      }

      /* Print media query to hide buttons when printing */
      @media print {
        /* Reset body for printing */
        body {
          background-color: white !important;
          margin: 0 !important;
          padding: 20px !important;
          font-size: 12pt;
        }

        /* Show print header */
        .print-header {
          display: block !important;
          text-align: center;
          font-size: 24px;
          font-weight: bold;
          margin-bottom: 20px;
          padding-bottom: 10px;
          border-bottom: 2px solid #333;
        }

        /* Hide elements not needed for printing */
        .navbar,
        .action-buttons,
        .filter-section,
        .btn,
        .modal,
        .stats-summary,
        .mushroom-bags-cards-container {
          display: none !important;
        }

        /* NEW: Hide/show tables based on print type */
        .harvest-report-container.hide-for-print,
        .mushroom-bags-container.hide-for-print {
          display: none !important;
        }

        /* Show only the selected table for printing */
        .harvest-report-container.show-for-print,
        .mushroom-bags-container.show-for-print {
          display: block !important;
        }

        /* Hide the Actions column when printing */
        .table thead th:nth-child(3),
        .table tbody td:nth-child(3) {
          display: none !important;
        }

        /* FIXED: For mushroom bags table, only hide Status (4th) and Actions (5th) columns when printing */
        /* Keep Bag Name (1), Type (2), and Weight (3) columns visible */
        .mushroom-bags-container .table thead th:nth-child(4),
        .mushroom-bags-container .table tbody td:nth-child(4),
        .mushroom-bags-container .table thead th:nth-child(5),
        .mushroom-bags-container .table tbody td:nth-child(5) {
          display: none !important;
        }

        /* Ensure Weight column (3rd) is visible for mushroom bags */
        .mushroom-bags-container .table thead th:nth-child(3),
        .mushroom-bags-container .table tbody td:nth-child(3) {
          display: table-cell !important;
        }

        /* Adjust table for printing */
        .table-container {
          box-shadow: none;
          border: 1px solid #ddd;
        }

        .table thead th {
          background: #333 !important;
          color: white !important;
        }

        .table-striped tbody tr:nth-of-type(odd) {
          background-color: #f9f9f9 !important;
        }

        /* Ensure table is black and white for printing */
        .table,
        .table th,
        .table td {
          color: black !important;
          border-color: #ddd !important;
        }

        /* Adjust container for printing */
        .report-container {
          width: 100% !important;
          max-width: 100% !important;
          margin: 0 !important;
          padding: 0 !important;
        }

        /* Show table container for mushroom bags when printing */
        .mushroom-bags-table-container {
          display: block !important;
        }

        /* Print-specific table styling for mushroom bags */
        .mushroom-bags-container {
          box-shadow: none;
          border: 1px solid #ddd;
          page-break-inside: avoid;
        }

        .mushroom-bags-header {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <!-- Toast container for messages -->
    <div class="toast-container">
      {% if messages %} {% for message in messages %}
      <div
        class="toast align-items-center text-white bg-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} border-0 show"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div class="toast-body">
            <i
              class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %} me-2"
            ></i>
            {{ message }}
          </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
      </div>
      {% endfor %} {% endif %}
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#"
          ><i class="fas fa-seedling"></i>SMARTSHROOM</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="{% url 'dashboard' %}"
                ><i class="fas fa-chart-line"></i> Dashboard</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="{% url 'report' %}"
                ><i class="fas fa-file-alt"></i> Report</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'scan' %}"
                ><i class="fas fa-qrcode"></i> Scan</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'remote' %}"
                ><i class="fas fa-wifi"></i> Remote</a
              >
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="fas fa-user-circle"></i>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="{% url 'profile' %}"
                    ><i class="fas fa-user"></i> Profile</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="{% url 'logout' %}"
                    ><i class="fas fa-sign-out-alt"></i> Logout</a
                  >
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="report-container">
      <div class="page-header">
        <h1 class="page-title">
          <i class="fas fa-clipboard-list"></i>Harvest Report
        </h1>
        <p class="page-subtitle">Track and manage your mushroom harvest data</p>
      </div>

      <!-- Print Header (hidden by default, shown only when printing) -->
      <div class="print-header">
        Naujan Mushroom Farm - Mushroom Bags Report
      </div>

      <!-- Stats Summary -->
      <div class="stats-summary">
        <div class="stat-card">
          <div class="stat-value">{{ total_harvest|default:"0" }}</div>
          <div class="stat-label">Total Harvest (kg)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ harvests|length }}</div>
          <div class="stat-label">Total Records</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ average_harvest|default:"0" }}</div>
          <div class="stat-label">Average per Harvest (kg)</div>
        </div>
      </div>

      <!-- Buttons (Add Harvest, Print Report) -->
      <div class="action-buttons">
        <div class="d-flex gap-2">
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#addHarvestModal"
          >
            <i class="fas fa-plus"></i> Add Harvest
          </button>
          <button
            class="btn btn-success"
            data-bs-toggle="modal"
            data-bs-target="#addMushroomBagModal"
          >
            <i class="fas fa-cube"></i> Add Mushroom Bag
          </button>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-secondary" onclick="showPrintOptions()">
            <i class="fas fa-print"></i> Print Report
          </button>
          <button class="btn btn-success" onclick="exportToExcel()">
            <i class="fas fa-file-excel"></i> Export to Excel
          </button>
        </div>
      </div>

      <!-- Print Options Modal -->
      <div class="modal fade" id="printOptionsModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                <i class="fas fa-print me-2"></i>Print Options
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Select Report to Print:</label>
                <div class="form-check mb-2">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="printOption"
                    id="printHarvest"
                    value="harvest"
                    checked
                  />
                  <label class="form-check-label" for="printHarvest">
                    Harvest Report (Date and Kilograms)
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="printOption"
                    id="printBags"
                    value="bags"
                  />
                  <label class="form-check-label" for="printBags">
                    Mushroom Bags (Bag Name, Type, and Weight)
                  </label>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="printSelectedReport()"
              >
                Print
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Search & Filter -->
      <div class="filter-section">
        <h3 class="filter-title">
          <i class="fas fa-filter"></i>Filter Results
        </h3>
        <div class="row g-3">
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-calendar-day"></i>
              </span>
              <input
                type="date"
                id="filterDate"
                class="form-control"
                placeholder="Filter by Date"
              />
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-calendar-month"></i>
              </span>
              <select id="filterMonth" class="form-select">
                <option value="">Filter by Month</option>
                <option value="01">January</option>
                <option value="02">February</option>
                <option value="03">March</option>
                <option value="04">April</option>
                <option value="05">May</option>
                <option value="06">June</option>
                <option value="07">July</option>
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
              </select>
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-calendar-year"></i>
              </span>
              <input
                type="number"
                id="filterYear"
                class="form-control"
                placeholder="Filter by Year"
                min="2000"
                max="2030"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- Harvest Report Table -->
      <div class="table-container harvest-report-container">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th><i class="fas fa-calendar me-2"></i>Date</th>
                <th><i class="fas fa-weight-scale me-2"></i>Kilograms</th>
                <th class="no-print"><i class="fas fa-cog me-2"></i>Actions</th>
              </tr>
            </thead>
            <tbody id="harvestTable">
              {% for harvest in harvests %}
              <tr id="harvest-row-{{ harvest.id }}">
                <td>{{ harvest.date }}</td>
                <td>{{ harvest.kilograms }}</td>
                <td class="action-buttons-cell no-print">
                  <button
                    class="btn btn-warning btn-sm"
                    onclick="editHarvest('{{ harvest.id }}', '{{ harvest.date }}', '{{ harvest.kilograms }}')"
                  >
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button
                    class="btn btn-danger btn-sm"
                    onclick="showDeleteWarning('{{ harvest.id }}')"
                  >
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="3" class="text-center py-4">No records found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Mushroom Bags Table -->
      <div class="mushroom-bags-container">
        <div class="mushroom-bags-header">
          <h3 class="mushroom-bags-title">
            <i class="fas fa-cubes me-2"></i>Mushroom Bags
          </h3>
          <div class="d-flex gap-2">
            <button
              class="btn btn-success btn-sm"
              data-bs-toggle="modal"
              data-bs-target="#addMushroomBagModal"
            >
              <i class="fas fa-plus"></i> Add Bag
            </button>
          </div>
        </div>

        <!-- Table view for larger screens -->
        <div class="mushroom-bags-table-container">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th><i class="fas fa-tag me-2"></i>Bag Name</th>
                  <th><i class="fas fa-seedling me-2"></i>Type</th>
                  <th><i class="fas fa-weight-scale me-2"></i>Weight (kg)</th>
                  <th class="no-print">
                    <i class="fas fa-info-circle me-2"></i>Status
                  </th>
                  <!-- <th><i class="fas fa-sticky-note me-2"></i>Notes</th> -->
                  <!-- <th><i class="fas fa-calendar me-2"></i>Created</th> -->
                  <th class="no-print">
                    <i class="fas fa-cog me-2"></i>Actions
                  </th>
                </tr>
              </thead>
              <tbody id="mushroomBagsTable">
                {% for bag in mushroom_bags %}
                <tr id="bag-row-{{ bag.id }}">
                  <td>{{ bag.bag_name }}</td>
                  <td>
                    <span class="badge bg-primary"
                      >{{ bag.bag_type|title }}</span
                    >
                  </td>
                  <td>{{ bag.weight }}</td>
                  <td class="no-print">
                    {% if bag.status == 'active' %}
                    <span class="badge bg-success">Active</span>
                    {% elif bag.status == 'incubating' %}
                    <span class="badge bg-info">Incubating</span>
                    {% elif bag.status == 'fruiting' %}
                    <span class="badge bg-warning">Fruiting</span>
                    {% elif bag.status == 'harvested' %}
                    <span class="badge bg-secondary">Harvested</span>
                    {% elif bag.status == 'discarded' %}
                    <span class="badge bg-danger">Discarded</span>
                    {% else %}
                    <span class="badge bg-secondary"
                      >{{ bag.status|title }}</span
                    >
                    {% endif %}
                  </td>
                  <!-- <td class="notes-cell">{{ bag.notes|default:"-" }}</td> -->
                  <!-- <td>
                    {% if bag.created_at %} {{ bag.created_at|date:"M d, Y" }} {%
                    else %} - {% endif %}
                  </td> -->
                  <td class="action-buttons-cell no-print">
                    <button
                      class="btn btn-warning btn-sm"
                      onclick="editBag('{{ bag.id }}', '{{ bag.bag_name }}', '{{ bag.bag_type }}', '{{ bag.weight }}', '{{ bag.status }}')"
                    >
                      <i class="fas fa-edit"></i> Edit
                    </button>
                    <button
                      class="btn btn-danger btn-sm"
                      onclick="showDeleteBagWarning('{{ bag.id }}')"
                    >
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="7" class="text-center py-4">
                    No mushroom bags found. Add your first bag to get started!
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Card view for mobile screens -->
        <div class="mushroom-bags-cards-container">
          {% for bag in mushroom_bags %}
          <div class="mushroom-bag-card" id="bag-card-{{ bag.id }}">
            <div class="bag-card-row">
              <div class="bag-card-label">Bag Name:</div>
              <div class="bag-card-value">{{ bag.bag_name }}</div>
            </div>
            <div class="bag-card-row">
              <div class="bag-card-label">Type:</div>
              <div class="bag-card-value">
                <span class="badge bg-primary">{{ bag.bag_type|title }}</span>
              </div>
            </div>
            <div class="bag-card-row">
              <div class="bag-card-label">Weight:</div>
              <div class="bag-card-value">{{ bag.weight }} kg</div>
            </div>
            <div class="bag-card-row">
              <div class="bag-card-label">Status:</div>
              <div class="bag-card-value">
                {% if bag.status == 'active' %}
                <span class="badge bg-success">Active</span>
                {% elif bag.status == 'incubating' %}
                <span class="badge bg-info">Incubating</span>
                {% elif bag.status == 'fruiting' %}
                <span class="badge bg-warning">Fruiting</span>
                {% elif bag.status == 'harvested' %}
                <span class="badge bg-secondary">Harvested</span>
                {% elif bag.status == 'discarded' %}
                <span class="badge bg-danger">Discarded</span>
                {% else %}
                <span class="badge bg-secondary">{{ bag.status|title }}</span>
                {% endif %}
              </div>
            </div>
            <div class="bag-card-actions">
              <button
                class="btn btn-warning btn-sm"
                onclick="editBag('{{ bag.id }}', '{{ bag.bag_name }}', '{{ bag.bag_type }}', '{{ bag.weight }}', '{{ bag.status }}')"
              >
                <i class="fas fa-edit"></i> Edit
              </button>
              <button
                class="btn btn-danger btn-sm"
                onclick="showDeleteBagWarning('{{ bag.id }}')"
              >
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          </div>
          {% empty %}
          <div class="text-center py-4">
            No mushroom bags found. Add your first bag to get started!
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Add Harvest Modal -->
    <div class="modal fade" id="addHarvestModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-leaf me-2"></i>Add Harvest
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form method="POST" action="{% url 'add_harvest' %}">
              {% csrf_token %}
              <input type="hidden" name="action" value="add" />
              <div class="mb-3">
                <label class="form-label">Date:</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-calendar"></i>
                  </span>
                  <input
                    type="date"
                    name="date"
                    class="form-control"
                    required
                  />
                </div>
              </div>
              <div class="mb-4">
                <label class="form-label">Kilograms:</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-scale-balanced"></i>
                  </span>
                  <input
                    type="number"
                    name="kilograms"
                    step="0.01"
                    class="form-control"
                    required
                  />
                </div>
              </div>
              <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-save me-2"></i>Save Harvest
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Mushroom Bag Modal -->
    <div class="modal fade" id="addMushroomBagModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-cube me-2"></i>Add Mushroom Bag
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form method="POST" action="{% url 'add_mushroom_bag' %}">
              {% csrf_token %}
              <div class="mb-3">
                <label class="form-label">Bag Name</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-tag"></i>
                  </span>
                  <input
                    type="text"
                    name="bag_name"
                    class="form-control"
                    required
                    placeholder="e.g., Bag #1, Oyster Batch A"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Mushroom Type</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-seedling"></i>
                  </span>
                  <select name="bag_type" class="form-select" required>
                    <option value="oyster">Oyster Mushroom</option>
                    <option value="shiitake">Shiitake</option>
                    <option value="button">Button Mushroom</option>
                    <option value="portobello">Portobello</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Weight (kg)</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-weight-scale"></i>
                  </span>
                  <input
                    type="number"
                    name="weight"
                    step="0.01"
                    class="form-control"
                    required
                    placeholder="0.00"
                    min="0"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Status</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-info-circle"></i>
                  </span>
                  <select name="status" class="form-select" required>
                    <option value="active">Active</option>
                    <option value="incubating">Incubating</option>
                    <option value="fruiting">Fruiting</option>
                    <option value="harvested">Harvested</option>
                    <option value="discarded">Discarded</option>
                  </select>
                </div>
              </div>
              <!-- <div class="mb-4">
                <label class="form-label">Notes (Optional)</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-sticky-note"></i>
                  </span>
                  <textarea
                    name="notes"
                    class="form-control"
                    rows="3"
                    placeholder="Any additional notes about this bag..."
                  ></textarea>
                </div>
              </div> -->
              <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-save me-2"></i>Save Bag
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Harvest Modal -->
    <div class="modal fade" id="editHarvestModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-edit me-2"></i>Edit Harvest
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form
              id="editHarvestForm"
              method="POST"
              action="{% url 'add_harvest' %}"
            >
              {% csrf_token %}
              <input type="hidden" name="action" value="edit" />
              <input type="hidden" id="edit_harvest_id" name="harvest_id" />
              <div class="mb-3">
                <label class="form-label">Date:</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-calendar"></i>
                  </span>
                  <input
                    type="date"
                    id="edit_harvest_date"
                    name="date"
                    class="form-control"
                    required
                  />
                </div>
              </div>
              <div class="mb-4">
                <label class="form-label">Kilograms:</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-scale-balanced"></i>
                  </span>
                  <input
                    type="number"
                    id="edit_harvest_kilograms"
                    name="kilograms"
                    step="0.01"
                    class="form-control"
                    required
                  />
                </div>
              </div>
              <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-save me-2"></i>Update Harvest
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              Are you sure you want to delete this harvest record? This action
              cannot be undone.
            </p>
            <form
              id="deleteHarvestForm"
              method="POST"
              action="{% url 'add_harvest' %}"
            >
              {% csrf_token %}
              <input type="hidden" name="action" value="delete" />
              <input type="hidden" id="delete_harvest_id" name="harvest_id" />
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="document.getElementById('deleteHarvestForm').submit()"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- NEW: Edit Mushroom Bag Modal -->
    <div class="modal fade" id="editMushroomBagModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-edit me-2"></i>Edit Mushroom Bag
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form
              id="editMushroomBagForm"
              method="POST"
              action="{% url 'add_mushroom_bag' %}"
            >
              {% csrf_token %}
              <input type="hidden" name="action" value="edit" />
              <input type="hidden" id="edit_bag_id" name="bag_id" />
              <div class="mb-3">
                <label class="form-label">Bag Name</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-tag"></i>
                  </span>
                  <input
                    type="text"
                    id="edit_bag_name"
                    name="bag_name"
                    class="form-control"
                    required
                    placeholder="e.g., Bag #1, Oyster Batch A"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Mushroom Type</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-seedling"></i>
                  </span>
                  <select
                    id="edit_bag_type"
                    name="bag_type"
                    class="form-select"
                    required
                  >
                    <option value="oyster">Oyster Mushroom</option>
                    <option value="shiitake">Shiitake</option>
                    <option value="button">Button Mushroom</option>
                    <option value="portobello">Portobello</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Weight (kg)</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-weight-scale"></i>
                  </span>
                  <input
                    type="number"
                    id="edit_bag_weight"
                    name="weight"
                    step="0.01"
                    class="form-control"
                    required
                    placeholder="0.00"
                    min="0"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Status</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-info-circle"></i>
                  </span>
                  <select
                    id="edit_bag_status"
                    name="status"
                    class="form-select"
                    required
                  >
                    <option value="active">Active</option>
                    <option value="incubating">Incubating</option>
                    <option value="fruiting">Fruiting</option>
                    <option value="harvested">Harvested</option>
                    <option value="discarded">Discarded</option>
                  </select>
                </div>
              </div>
              <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-save me-2"></i>Update Bag
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- NEW: Delete Bag Confirmation Modal -->
    <div class="modal fade" id="deleteBagConfirmationModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-exclamation-triangle me-2"></i>Confirm Bag
              Deletion
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              Are you sure you want to delete this mushroom bag? This action
              cannot be undone.
            </p>
            <form
              id="deleteBagForm"
              method="POST"
              action="{% url 'add_mushroom_bag' %}"
            >
              {% csrf_token %}
              <input type="hidden" name="action" value="delete" />
              <input type="hidden" id="delete_bag_id" name="bag_id" />
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="document.getElementById('deleteBagForm').submit()"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script>
      // Function to show print options modal
      function showPrintOptions() {
        var printModal = new bootstrap.Modal(
          document.getElementById("printOptionsModal")
        );
        printModal.show();
      }

      // Function to print selected report
      function printSelectedReport() {
        const selectedOption = document.querySelector(
          'input[name="printOption"]:checked'
        ).value;

        // Add classes to control what gets printed
        if (selectedOption === "harvest") {
          document
            .querySelector(".harvest-report-container")
            .classList.add("show-for-print");
          document
            .querySelector(".mushroom-bags-container")
            .classList.add("hide-for-print");
        } else {
          document
            .querySelector(".harvest-report-container")
            .classList.add("hide-for-print");
          document
            .querySelector(".mushroom-bags-container")
            .classList.add("show-for-print");
        }

        // Close the modal
        var printModal = bootstrap.Modal.getInstance(
          document.getElementById("printOptionsModal")
        );
        printModal.hide();

        // Trigger print
        window.print();

        // Remove the classes after printing (in case user cancels print)
        setTimeout(() => {
          document
            .querySelector(".harvest-report-container")
            .classList.remove("show-for-print", "hide-for-print");
          document
            .querySelector(".mushroom-bags-container")
            .classList.remove("show-for-print", "hide-for-print");
        }, 500);
      }

      // Function to export table to Excel
      function exportToExcel() {
        // Get the table
        const table = document.getElementById("harvestTable");

        // Prepare workbook
        const wb = XLSX.utils.book_new();

        // Convert table to worksheet
        const ws = XLSX.utils.table_to_sheet(table);

        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, "Harvest Report");

        // Generate excel file
        XLSX.writeFile(
          wb,
          `Harvest_Report_${new Date().toISOString().split("T")[0]}.xlsx`
        );
      }

      // Filtering function
      document
        .getElementById("filterDate")
        .addEventListener("change", filterTable);
      document
        .getElementById("filterMonth")
        .addEventListener("change", filterTable);
      document
        .getElementById("filterYear")
        .addEventListener("input", filterTable);

      function filterTable() {
        let dateFilter = document.getElementById("filterDate").value;
        let monthFilter = document.getElementById("filterMonth").value;
        let yearFilter = document.getElementById("filterYear").value;
        let rows = document.querySelectorAll("#harvestTable tr");

        rows.forEach((row) => {
          let date = row.cells[0].textContent.trim();
          let show = true;

          if (dateFilter && !date.includes(dateFilter)) show = false;
          if (monthFilter && !date.includes(`-${monthFilter}-`)) show = false;
          if (yearFilter && !date.startsWith(yearFilter)) show = false;

          row.style.display = show ? "" : "none";
        });
      }

      // Edit Harvest Function
      function editHarvest(id, date, kilograms) {
        document.getElementById("edit_harvest_id").value = id;
        document.getElementById("edit_harvest_date").value = date;
        document.getElementById("edit_harvest_kilograms").value = kilograms;

        // Show the modal
        var editModal = new bootstrap.Modal(
          document.getElementById("editHarvestModal")
        );
        editModal.show();
      }

      // NEW: Edit Bag Function
      function editBag(id, name, type, weight, status) {
        document.getElementById("edit_bag_id").value = id;
        document.getElementById("edit_bag_name").value = name;
        document.getElementById("edit_bag_type").value = type;
        document.getElementById("edit_bag_weight").value = weight;
        document.getElementById("edit_bag_status").value = status;

        // Show the modal
        var editModal = new bootstrap.Modal(
          document.getElementById("editMushroomBagModal")
        );
        editModal.show();
      }

      // NEW: Show delete bag confirmation
      function showDeleteBagWarning(id) {
        document.getElementById("delete_bag_id").value = id;
        var deleteModal = new bootstrap.Modal(
          document.getElementById("deleteBagConfirmationModal")
        );
        deleteModal.show();
      }

      // Show delete confirmation
      function showDeleteWarning(id) {
        document.getElementById("delete_harvest_id").value = id;
        var deleteModal = new bootstrap.Modal(
          document.getElementById("deleteConfirmationModal")
        );
        deleteModal.show();
      }

      // Auto-hide toasts after 5 seconds
      document.addEventListener("DOMContentLoaded", function () {
        const toasts = document.querySelectorAll(".toast");
        toasts.forEach((toast) => {
          setTimeout(() => {
            const bsToast = new bootstrap.Toast(toast);
            bsToast.hide();
          }, 5000);
        });
      });
    </script>
  </body>
</html>
